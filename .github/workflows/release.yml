name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
  build:
    name: Build Release APKs
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: |
        chmod +x android-client/gradlew
        chmod +x android-tv/gradlew
        
    - name: Build Android Client
      run: |
        cd android-client
        ./gradlew assembleDebug
        
    - name: Build Android TV
      run: |
        cd android-tv
        ./gradlew assembleDebug
        
    - name: Rename APKs
      run: |
        mkdir -p release
        cp android-client/app/build/outputs/apk/debug/app-debug.apk release/screencast-client.apk
        cp android-tv/app/build/outputs/apk/debug/app-debug.apk release/screencast-tv.apk
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/screencast-client.apk
          release/screencast-tv.apk
        body: |
          ## 安卓投屏应用
          
          ### 下载说明
          - `screencast-client.apk`: 手机端应用
          - `screencast-tv.apk`: 投影仪/电视端应用
          
          ### 使用方法
          1. 在投影仪上安装并打开 screencast-tv.apk
          2. 在手机上安装并打开 screencast-client.apk
          3. 扫描投影仪上的二维码
          4. 授予权限后开始投屏
          
          ### 注意事项
          - 确保两个设备在同一 WiFi 网络
          - 需要开启"允许安装未知来源应用"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
